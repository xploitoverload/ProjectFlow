<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ProjectFlow{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Webify Theme (Primary) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/webify-theme.css') }}">
    
    <!-- Additional Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-features.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/global-navigation.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/issue-table-advanced.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/issue-detail-panel.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/board-view.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/service-desk-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/reports-analytics-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/automation-workflow-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/calendar-view-complete.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/change-calendar-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feature-pages.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feature-pages-pro.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/master-fix.css') }}">
    
    <!-- Iconify Icons -->
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    
    <script defer src=\"{{ url_for('static', filename='js/core-ui.js') }}\"></script>\n    <script defer src=\"{{ url_for('static', filename='js/lucide.min.js') }}\"></script>"
    <script defer src="{{ url_for('static', filename='js/theme-manager.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/notification-manager.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/breadcrumb-manager.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/issue-table-advanced.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/issue-detail-panel.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/board-view.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/backlog-view.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/timeline-view.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/advanced-jql-builder.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/service-desk-system.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/reports-analytics-system.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/automation-workflow-system.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/advanced-search-filters.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/user-management-system.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/integrations-apps-system.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/mobile-responsive-system.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/calendar-view-complete.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/change-calendar-system.js') }}"></script>
    {% block extra_head %}{% endblock %}
</head>
<body>
    <div class="app-shell">
        <!-- Sidebar -->
        <aside class="app-sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="{{ url_for('main.dashboard') }}" class="sidebar-logo">
                    <div class="sidebar-logo-icon">
                        <span class="iconify" data-icon="solar:layers-bold-duotone" style="width: 22px; height: 22px;"></span>
                    </div>
                    <span class="sidebar-logo-text">ProjectFlow</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <!-- For You Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">For you</div>
                    <a href="{{ url_for('main.dashboard') }}" class="sidebar-nav-item {% if request.endpoint == 'main.dashboard' %}active{% endif %}">
                        <span class="iconify nav-icon" data-icon="solar:home-2-bold-duotone"></span>
                        <span>Home</span>
                    </a>
                    <a href="{{ url_for('main.dashboard') }}" class="sidebar-nav-item">
                        <span class="iconify nav-icon" data-icon="solar:clock-circle-bold-duotone"></span>
                        <span>Recent</span>
                    </a>
                    <a href="javascript:void(0)" id="sidebarNotifications" class="sidebar-nav-item">
                        <span class="iconify nav-icon" data-icon="solar:bell-bold-duotone"></span>
                        <span>Notifications</span>
                        <span class="notification-badge ml-auto">0</span>
                    </a>
                </div>

                <!-- Work Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Work</div>
                    <a href="{{ url_for('main.issues') }}" class="sidebar-nav-item {% if request.endpoint == 'main.issues' %}active{% endif %}">
                        <span class="iconify nav-icon" data-icon="solar:checklist-minimalistic-bold-duotone"></span>
                        <span>Issues</span>
                    </a>
                    <a href="{{ url_for('main.board') }}" class="sidebar-nav-item {% if request.endpoint == 'main.board' %}active{% endif %}">
                        <span class="iconify nav-icon" data-icon="solar:widget-5-bold-duotone"></span>
                        <span>Board</span>
                    </a>
                    <a href="{{ url_for('main.backlog') }}" class="sidebar-nav-item {% if request.endpoint == 'main.backlog' %}active{% endif %}">
                        <span class="iconify nav-icon" data-icon="solar:list-bold-duotone"></span>
                        <span>Backlog</span>
                    </a>
                    <a href="{{ url_for('main.timeline') }}" class="sidebar-nav-item {% if request.endpoint == 'main.timeline' %}active{% endif %}">
                        <span class="iconify nav-icon" data-icon="solar:chart-2-bold-duotone"></span>
                        <span>Timeline</span>
                    </a>
                    <a href="{{ url_for('main.calendar') }}" class="sidebar-nav-item {% if request.endpoint == 'main.calendar' %}active{% endif %}">
                        <span class="iconify nav-icon" data-icon="solar:calendar-bold-duotone"></span>
                        <span>Calendar</span>
                    </a>
                    <a href="{{ url_for('admin.admin_teams') if current_user.is_authenticated and current_user.role == 'admin' else '#' }}" class="sidebar-nav-item">
                        <span class="iconify nav-icon" data-icon="solar:users-group-rounded-bold-duotone"></span>
                        <span>Teams</span>
                    </a>
                    <a href="{{ url_for('admin.admin_projects') if current_user.is_authenticated and current_user.role == 'admin' else '#' }}" class="sidebar-nav-item">
                        <span class="iconify nav-icon" data-icon="solar:folder-with-files-bold-duotone"></span>
                        <span>Projects</span>
                    </a>
                </div>

                <!-- Tools Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Tools</div>
                    <a href="{{ url_for('main.search') }}" class="sidebar-nav-item">
                        <span class="iconify nav-icon" data-icon="solar:magnifer-bold-duotone"></span>
                        <span>Search</span>
                    </a>
                    <a href="{{ url_for('main.analytics') }}" class="sidebar-nav-item {% if request.endpoint == 'main.analytics' %}active{% endif %}">
                        <span class="iconify nav-icon" data-icon="solar:chart-bold-duotone"></span>
                        <span>Analytics</span>
                    </a>
                    <a href="{{ url_for('progress.submit_update') }}" class="sidebar-nav-item {% if request.endpoint == 'progress.submit_update' %}active{% endif %}">
                        <span class="iconify nav-icon" data-icon="solar:document-add-bold-duotone"></span>
                        <span>Progress Updates</span>
                    </a>
                    <a href="{{ url_for('main.service_desk') }}" class="sidebar-nav-item">
                        <span class="iconify nav-icon" data-icon="solar:headphones-round-bold-duotone"></span>
                        <span>Service Desk</span>
                    </a>
                    <a href="{{ url_for('main.automation') }}" class="sidebar-nav-item">
                        <span class="iconify nav-icon" data-icon="solar:bolt-bold-duotone"></span>
                        <span>Automation</span>
                    </a>
                    <a href="{{ url_for('main.change_calendar') }}" class="sidebar-nav-item">
                        <span class="iconify nav-icon" data-icon="solar:calendar-mark-bold-duotone"></span>
                        <span>Change Calendar</span>
                    </a>
                    <a href="{{ url_for('main.integrations') }}" class="sidebar-nav-item">
                        <span class="iconify nav-icon" data-icon="solar:plug-circle-bold-duotone"></span>
                        <span>Integrations</span>
                    </a>
                </div>

                {% if current_user.is_authenticated and current_user.role == 'admin' %}
                <!-- Administration -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Administration</div>
                    <a href="{{ url_for('admin.admin_dashboard') }}" class="sidebar-nav-item">
                        <span class="iconify nav-icon" data-icon="solar:settings-bold-duotone"></span>
                        <span>Settings</span>
                    </a>
                    <a href="{{ url_for('admin.admin_users') }}" class="sidebar-nav-item">
                        <span class="iconify nav-icon" data-icon="solar:users-group-two-rounded-bold-duotone"></span>
                        <span>Users</span>
                    </a>
                    <a href="{{ url_for('admin.security_dashboard') }}" class="sidebar-nav-item">
                        <span class="iconify nav-icon" data-icon="solar:shield-check-bold-duotone"></span>
                        <span>Security</span>
                    </a>
                    <a href="{{ url_for('progress.admin_pending') }}" class="sidebar-nav-item {% if request.endpoint == 'progress.admin_pending' %}active{% endif %}">
                        <span class="iconify nav-icon" data-icon="solar:inbox-in-bold-duotone"></span>
                        <span>Progress Reviews</span>
                    </a>
                </div>
                {% endif %}
            </nav>

            <div class="sidebar-footer">
                <a href="{{ url_for('main.profile') }}" class="sidebar-user">
                    <div class="sidebar-user-avatar" style="background: {{ current_user.avatar_color if current_user.is_authenticated else 'var(--webify-gradient-primary)' }};">
                        {{ current_user.username[:2].upper() if current_user.is_authenticated else 'U' }}
                    </div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name">{{ current_user.username if current_user.is_authenticated else 'User' }}</div>
                        <div class="sidebar-user-role">{{ current_user.role.title() if current_user.is_authenticated and current_user.role else 'Guest' }}</div>
                    </div>
                    <span class="iconify" data-icon="solar:alt-arrow-right-linear" style="width: 16px; height: 16px; color: var(--webify-text-tertiary);"></span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="app-main">
            <!-- Header -->
            <header class="app-header">
                <div class="header-left">
                    <button class="header-icon-btn" id="sidebarToggle" style="display: none;">
                        <span class="iconify" data-icon="solar:hamburger-menu-bold"></span>
                    </button>
                    {% block breadcrumb %}
                    <div class="header-breadcrumb">
                        <span>Home</span>
                        <span class="iconify header-breadcrumb-separator" data-icon="solar:alt-arrow-right-linear" style="width: 14px; height: 14px;"></span>
                        <span class="header-breadcrumb-current">Dashboard</span>
                    </div>
                    {% endblock %}
                </div>
                <div class="header-right">
                    <div class="header-search">
                        <span class="iconify header-search-icon" data-icon="solar:magnifer-linear"></span>
                        <input type="text" class="header-search-input" placeholder="Search projects... (âŒ˜K)">
                    </div>
                    
                    <!-- Notifications Button -->
                    <button class="header-icon-btn" id="notificationBtn" style="position: relative;" title="Notifications">
                        <span class="iconify" data-icon="solar:bell-bold"></span>
                        <span class="notification-badge">0</span>
                    </button>
                    
                    <!-- Theme Toggle -->
                    <button class="header-icon-btn theme-toggle-btn" id="themeToggle" title="Toggle Theme">
                        <span class="iconify" data-icon="solar:moon-bold"></span>
                    </button>
                    
                    <!-- Settings -->
                    <button class="header-icon-btn" title="Settings">
                        <span class="iconify" data-icon="solar:settings-bold"></span>
                    </button>
                    
                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-ghost btn-sm">
                        <span class="iconify icon-sm" data-icon="solar:logout-2-bold"></span>
                        Sign out
                    </a>
                    {% endif %}
                </div>
            </header>

            <!-- Content -->
            <div class="app-content">
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'error' if category == 'danger' else category }} animate-fadeInDown">
                                <span class="iconify alert-icon" data-icon="{{ 'solar:danger-triangle-bold' if category in ['danger', 'error'] else 'solar:check-circle-bold' }}"></span>
                                <div class="alert-content">{{ message }}</div>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Main Content Block -->
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-panel-header">
            <h3 class="notification-panel-title">Notifications</h3>
            <button class="notification-panel-close" id="closeNotifications">
                <span class="iconify" data-icon="solar:close-circle-bold" style="width: 20px; height: 20px;"></span>
            </button>
        </div>
        <div class="notification-panel-content" id="notificationList">
            <div class="empty-state">
                <div class="empty-state-icon">
                    <span class="iconify" data-icon="solar:bell-off-bold-duotone" style="width: 40px; height: 40px;"></span>
                </div>
                <p class="empty-state-title">No notifications</p>
                <p class="empty-state-text">You're all caught up!</p>
            </div>
        </div>
    </div>

    <!-- Base JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Base: DOM Content Loaded');
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
                console.log('Base: Lucide icons initialized');
            } else {
                console.error('Base: Lucide not loaded');
            }

            // Initialize Theme Manager
            if (typeof window.themeManager !== 'undefined') {
                console.log('Base: Theme manager ready');
            } else {
                console.error('Base: Theme manager not loaded');
            }

            // Initialize Notification Manager
            if (typeof window.notificationManager !== 'undefined') {
                console.log('Base: Notification manager ready');
            } else {
                console.error('Base: Notification manager not loaded');
            }

            // Theme Toggle Button
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle && window.themeManager) {
                themeToggle.addEventListener('click', function() {
                    window.themeManager.toggleTheme();
                });
                console.log('Base: Theme toggle button initialized');
            }

            // Notification Button
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationPanel = document.getElementById('notificationPanel');
            const closeNotifications = document.getElementById('closeNotifications');
            
            if (notificationBtn && notificationPanel) {
                notificationBtn.addEventListener('click', function() {
                    notificationPanel.classList.toggle('show');
                });
                console.log('Base: Notification button initialized');
            }
            
            if (closeNotifications && notificationPanel) {
                closeNotifications.addEventListener('click', function() {
                    notificationPanel.classList.remove('show');
                });
            }

            // Sidebar Notifications
            const sidebarNotifications = document.getElementById('sidebarNotifications');
            if (sidebarNotifications && notificationPanel) {
                sidebarNotifications.addEventListener('click', function(e) {
                    e.preventDefault();
                    notificationPanel.classList.toggle('show');
                });
            }

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + D - Toggle theme
                if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                    e.preventDefault();
                    if (window.themeManager) {
                        window.themeManager.toggleTheme();
                    }
                }

                // Ctrl/Cmd + K - Focus search
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    const searchInput = document.querySelector('.header-search-input');
                    if (searchInput) {
                        searchInput.focus();
                    }
                }
            });

            console.log('Base: All event listeners attached');
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
