<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ProjectFlow{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/design-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-features.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/global-navigation.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/issue-table-advanced.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/issue-detail-panel.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/board-view.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/service-desk-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/reports-analytics-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/automation-workflow-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/calendar-view-complete.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/change-calendar-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feature-pages.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feature-pages-pro.css') }}">
    <!-- Master fix - replaces all individual fix files -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/master-fix.css') }}">
    <script defer src="{{ url_for('static', filename='js/lucide.min.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/theme-manager.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/notification-manager.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/breadcrumb-manager.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/issue-table-advanced.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/issue-detail-panel.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/board-view.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/backlog-view.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/timeline-view.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/advanced-jql-builder.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/service-desk-system.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/reports-analytics-system.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/automation-workflow-system.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/advanced-search-filters.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/user-management-system.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/integrations-apps-system.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/mobile-responsive-system.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/calendar-view-complete.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/change-calendar-system.js') }}"></script>
    {% block extra_head %}{% endblock %}
</head>
<body>
    <div class="app-shell">
        <!-- Sidebar -->
        <aside class="app-sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="{{ url_for('main.dashboard') }}" class="sidebar-logo">
                    <div class="sidebar-logo-icon">
                        <i data-lucide="layers" style="width: 20px; height: 20px;"></i>
                    </div>
                    <span class="sidebar-logo-text">ProjectFlow</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <!-- For You Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">For you</div>
                    <a href="{{ url_for('main.dashboard') }}" class="sidebar-nav-item">
                        <i data-lucide="home" class="nav-icon"></i>
                        <span>Home</span>
                    </a>
                    <a href="{{ url_for('main.dashboard') }}" class="sidebar-nav-item">
                        <i data-lucide="clock" class="nav-icon"></i>
                        <span>Recent</span>
                    </a>
                    <a href="javascript:void(0)" id="sidebarNotifications" class="sidebar-nav-item">
                        <i data-lucide="bell" class="nav-icon"></i>
                        <span>Notifications</span>
                        <span class="notification-badge ml-auto">0</span>
                    </a>
                </div>

                <!-- Work Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Work</div>
                    <a href="{{ url_for('main.issues') }}" class="sidebar-nav-item">
                        <i data-lucide="list-checks" class="nav-icon"></i>
                        <span>Issues</span>
                    </a>
                    <a href="{{ url_for('main.board') }}" class="sidebar-nav-item">
                        <i data-lucide="kanban-square" class="nav-icon"></i>
                        <span>Board</span>
                    </a>
                    <a href="{{ url_for('main.backlog') }}" class="sidebar-nav-item">
                        <i data-lucide="list" class="nav-icon"></i>
                        <span>Backlog</span>
                    </a>
                    <a href="{{ url_for('main.timeline') }}" class="sidebar-nav-item">
                        <i data-lucide="gantt-chart" class="nav-icon"></i>
                        <span>Timeline</span>
                    </a>
                    <a href="{{ url_for('main.calendar') }}" class="sidebar-nav-item">
                        <i data-lucide="calendar" class="nav-icon"></i>
                        <span>Calendar</span>
                    </a>
                    <a href="{{ url_for('admin.admin_teams') if current_user.is_authenticated and current_user.role == 'admin' else '#' }}" class="sidebar-nav-item">
                        <i data-lucide="users-round" class="nav-icon"></i>
                        <span>Teams</span>
                    </a>
                    <a href="{{ url_for('admin.admin_projects') if current_user.is_authenticated and current_user.role == 'admin' else '#' }}" class="sidebar-nav-item">
                        <i data-lucide="folder" class="nav-icon"></i>
                        <span>Projects</span>
                    </a>
                </div>

                <!-- Tools Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Tools</div>
                    <a href="{{ url_for('main.search') }}" class="sidebar-nav-item">
                        <i data-lucide="search" class="nav-icon"></i>
                        <span>Search</span>
                    </a>
                    <a href="{{ url_for('main.analytics') }}" class="sidebar-nav-item">
                        <i data-lucide="bar-chart-3" class="nav-icon"></i>
                        <span>Analytics</span>
                    </a>
                    <a href="{{ url_for('main.service_desk') }}" class="sidebar-nav-item">
                        <i data-lucide="headphones" class="nav-icon"></i>
                        <span>Service Desk</span>
                    </a>
                    <a href="{{ url_for('main.automation') }}" class="sidebar-nav-item">
                        <i data-lucide="zap" class="nav-icon"></i>
                        <span>Automation</span>
                    </a>
                    <a href="{{ url_for('main.change_calendar') }}" class="sidebar-nav-item">
                        <i data-lucide="calendar-clock" class="nav-icon"></i>
                        <span>Change Calendar</span>
                    </a>
                    <a href="{{ url_for('main.integrations') }}" class="sidebar-nav-item">
                        <i data-lucide="plug" class="nav-icon"></i>
                        <span>Integrations</span>
                    </a>
                </div>

                {% if current_user.is_authenticated and current_user.role == 'admin' %}
                <!-- Administration -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Administration</div>
                    <a href="{{ url_for('admin.admin_dashboard') }}" class="sidebar-nav-item">
                        <i data-lucide="settings" class="nav-icon"></i>
                        <span>Settings</span>
                    </a>
                    <a href="{{ url_for('admin.admin_users') }}" class="sidebar-nav-item">
                        <i data-lucide="users" class="nav-icon"></i>
                        <span>Users</span>
                    </a>
                    <a href="{{ url_for('admin.security_dashboard') }}" class="sidebar-nav-item">
                        <i data-lucide="shield" class="nav-icon"></i>
                        <span>Security</span>
                    </a>
                </div>
                {% endif %}
            </nav>

            <div class="sidebar-footer">
                <a href="{{ url_for('main.profile') }}" class="sidebar-user">
                    <div class="sidebar-user-avatar" style="background: {{ current_user.avatar_color if current_user.is_authenticated else 'var(--primary-100)' }};">
                        {{ current_user.username[:2].upper() if current_user.is_authenticated else 'U' }}
                    </div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name">{{ current_user.username if current_user.is_authenticated else 'User' }}</div>
                        <div class="sidebar-user-role">{{ current_user.role.title() if current_user.is_authenticated and current_user.role else 'Guest' }}</div>
                    </div>
                    <i data-lucide="chevron-right" style="width: 16px; height: 16px; color: var(--text-tertiary);"></i>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="app-main">
            <!-- Header -->
            <header class="app-header">
                <div class="header-left">
                    <button class="header-icon-btn" id="sidebarToggle" style="display: none;">
                        <i data-lucide="menu"></i>
                    </button>
                    {% block breadcrumb %}
                    <div class="header-breadcrumb">
                        <span>Home</span>
                        <i data-lucide="chevron-right" class="header-breadcrumb-separator" style="width: 14px; height: 14px;"></i>
                        <span class="header-breadcrumb-current">Page</span>
                    </div>
                    {% endblock %}
                </div>
                <div class="header-right">
                    <div class="header-search">
                        <i data-lucide="search" class="header-search-icon"></i>
                        <input type="text" class="header-search-input" placeholder="Search projects...">
                    </div>
                    
                    <!-- Notifications Button -->
                    <button class="header-icon-btn" id="notificationBtn" style="position: relative;" title="Notifications">
                        <i data-lucide="bell"></i>
                        <span class="notification-badge">0</span>
                    </button>
                    
                    <!-- Theme Toggle -->
                    <button class="header-icon-btn theme-toggle-btn" id="themeToggle" title="Toggle Theme">
                        <i data-lucide="moon"></i>
                    </button>
                    
                    <!-- Settings -->
                    <button class="header-icon-btn" title="Settings">
                        <i data-lucide="settings"></i>
                    </button>
                    
                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-ghost btn-sm">
                        <i data-lucide="log-out" class="icon-sm"></i>
                        Sign out
                    </a>
                    {% endif %}
                </div>
            </header>

            <!-- Content -->
            <div class="app-content">
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'error' if category == 'danger' else category }}">
                                <i data-lucide="{{ 'alert-circle' if category in ['danger', 'error'] else 'check-circle' }}" class="alert-icon"></i>
                                <div class="alert-content">{{ message }}</div>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Main Content Block -->
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-panel-header">
            <h3 class="notification-panel-title">Notifications</h3>
            <button class="notification-panel-close" id="closeNotifications">
                <i data-lucide="x" style="width: 20px; height: 20px;"></i>
            </button>
        </div>
        <div class="notification-panel-content" id="notificationList">
            <!-- Notifications will be dynamically added here -->
        </div>
    </div>

    <!-- Base JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Base: DOM Content Loaded');
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
                console.log('Base: Lucide icons initialized');
            } else {
                console.error('Base: Lucide not loaded');
            }

            // Initialize Theme Manager
            if (typeof window.themeManager !== 'undefined') {
                console.log('Base: Theme manager ready');
            } else {
                console.error('Base: Theme manager not loaded');
            }

            // Initialize Notification Manager
            if (typeof window.notificationManager !== 'undefined') {
                console.log('Base: Notification manager ready');
            } else {
                console.error('Base: Notification manager not loaded');
            }

            // Theme Toggle Button
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle && window.themeManager) {
                themeToggle.addEventListener('click', function() {
                    window.themeManager.toggleTheme();
                });
                console.log('Base: Theme toggle button initialized');
            }

            // Notification Button
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationPanel = document.getElementById('notificationPanel');
            const closeNotifications = document.getElementById('closeNotifications');
            
            if (notificationBtn && notificationPanel) {
                notificationBtn.addEventListener('click', function() {
                    notificationPanel.classList.toggle('show');
                });
                console.log('Base: Notification button initialized');
            }
            
            if (closeNotifications && notificationPanel) {
                closeNotifications.addEventListener('click', function() {
                    notificationPanel.classList.remove('show');
                });
            }

            // Sidebar Notifications
            const sidebarNotifications = document.getElementById('sidebarNotifications');
            if (sidebarNotifications && notificationPanel) {
                sidebarNotifications.addEventListener('click', function(e) {
                    e.preventDefault();
                    notificationPanel.classList.toggle('show');
                });
            }

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + D - Toggle theme
                if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                    e.preventDefault();
                    if (window.themeManager) {
                        window.themeManager.toggleTheme();
                    }
                }

                // Ctrl/Cmd + K - Focus search
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    const searchInput = document.querySelector('.header-search-input');
                    if (searchInput) {
                        searchInput.focus();
                    }
                }
            });

            console.log('Base: All event listeners attached');
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
