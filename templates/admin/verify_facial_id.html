{% extends "base.html" %}

{% block title %}Verify with Facial ID - Admin{% endblock %}

{% block content %}
<div class="admin-container">
  <div class="verify-facial-container">
    <div class="verify-header">
      <h1>üîê Verify Your Identity</h1>
      <p>Use facial recognition to continue</p>
    </div>

    <div class="verify-content">
      <!-- Camera Section -->
      <div class="verify-camera-section">
        <div class="camera-wrapper">
          <video id="verifyCamera" autoplay playsinline></video>
          <canvas id="verifyCanvas" style="display: none;"></canvas>
          
          <!-- Face Guide Overlay -->
          <div class="face-guide-overlay">
            <svg viewBox="0 0 300 400" class="face-guide">
              <ellipse cx="150" cy="150" rx="80" ry="100" fill="none" stroke="#0284c7" stroke-width="3"/>
              <circle cx="110" cy="120" r="5" fill="#0284c7"/>
              <circle cx="190" cy="120" r="5" fill="#0284c7"/>
              <text x="150" y="280" text-anchor="middle" fill="#0284c7" font-size="14" font-weight="bold">
                Position your face
              </text>
            </svg>
          </div>

          <!-- Status Indicator -->
          <div class="verification-status" id="verificationStatus">
            <span class="status-dot"></span>
            <span class="status-text">Initializing camera...</span>
          </div>

          <!-- Live Detection Confidence -->
          <div class="confidence-meter" id="confidenceMeter" style="display: none;">
            <div class="meter-bar">
              <div class="meter-fill" id="meterFill"></div>
            </div>
            <span class="meter-text" id="confidenceText">Confidence: 0%</span>
          </div>
        </div>

        <!-- Controls -->
        <div class="verify-controls">
          <button type="button" id="startVerifyBtn" class="btn btn-primary btn-lg">
            <span class="icon">üì∑</span> Start Verification
          </button>
          <button type="button" id="captureVerifyBtn" class="btn btn-success btn-lg" disabled style="display: none;">
            <span class="icon">üì∏</span> Capture Face
          </button>
          <button type="button" id="stopVerifyBtn" class="btn btn-secondary" style="display: none;">
            Stop Camera
          </button>
        </div>

        <!-- Processing Indicator -->
        <div id="processingIndicator" class="processing-indicator" style="display: none;">
          <div class="processing-spinner"></div>
          <p>Verifying your face...</p>
        </div>
      </div>

      <!-- Results Section -->
      <div id="verificationResult" class="verification-result" style="display: none;">
        <div class="result-content" id="resultContent"></div>
        <button type="button" id="retryVerifyBtn" class="btn btn-primary">Try Again</button>
      </div>

      <!-- Info Section -->
      <div class="verify-info">
        <div class="info-card">
          <h3>üí° Tips for Best Results</h3>
          <ul>
            <li>Ensure good lighting on your face</li>
            <li>Position camera at eye level</li>
            <li>Keep face fully visible and centered</li>
            <li>Use the same location where you enrolled</li>
            <li>Remove glasses if they create glare</li>
          </ul>
        </div>

        <div class="info-card">
          <h3>‚è±Ô∏è Timeout Information</h3>
          <p>You have <strong>5 minutes</strong> to complete facial verification before your session expires.</p>
          <p class="text-muted">After successful verification, you remain authenticated for <strong>30 minutes</strong>.</p>
        </div>

        <div class="info-card backup-code">
          <h3>üîë Having Trouble?</h3>
          <p>If facial ID verification fails, you can:</p>
          <ul>
            <li>Try again with better lighting</li>
            <li>Use your TOTP backup codes</li>
            <li>Contact your security administrator</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.verify-facial-container {
  max-width: 800px;
  margin: 2rem auto;
  padding: 2rem;
}

.verify-header {
  text-align: center;
  margin-bottom: 2rem;
}

.verify-header h1 {
  margin: 0 0 0.5rem;
  font-size: 2rem;
}

.verify-header p {
  color: var(--dark-text-muted);
  margin: 0;
}

.verify-content {
  background: var(--dark-surface);
  border-radius: 0.75rem;
  border: 1px solid var(--dark-border);
  padding: 2rem;
}

.verify-camera-section {
  margin-bottom: 2rem;
}

.camera-wrapper {
  position: relative;
  width: 100%;
  aspect-ratio: 1 / 1.3;
  background: #000;
  border-radius: 0.75rem;
  overflow: hidden;
  margin-bottom: 1.5rem;
}

#verifyCamera {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.face-guide-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}

.face-guide {
  width: 180px;
  height: 240px;
  filter: drop-shadow(0 0 15px rgba(2, 132, 199, 0.6));
}

.verification-status {
  position: absolute;
  bottom: 1rem;
  left: 1rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  background: rgba(0, 0, 0, 0.8);
  color: var(--primary-light);
  padding: 0.75rem 1.25rem;
  border-radius: 9999px;
  font-size: 0.9rem;
  border: 1px solid var(--primary);
}

.status-dot {
  width: 8px;
  height: 8px;
  background: var(--primary-light);
  border-radius: 50%;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.verification-status.success {
  background: rgba(34, 197, 94, 0.2);
  color: var(--success);
  border-color: var(--success);
}

.verification-status.success .status-dot {
  background: var(--success);
}

.verification-status.error {
  background: rgba(239, 68, 68, 0.2);
  color: var(--error);
  border-color: var(--error);
}

.verification-status.error .status-dot {
  background: var(--error);
}

.confidence-meter {
  position: absolute;
  top: 1rem;
  right: 1rem;
  width: 200px;
}

.meter-bar {
  height: 4px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 2px;
  overflow: hidden;
  margin-bottom: 0.5rem;
}

.meter-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--success));
  width: 0%;
  transition: width 0.2s ease;
}

.meter-text {
  font-size: 0.75rem;
  color: var(--dark-text-muted);
}

.verify-controls {
  display: flex;
  gap: 1rem;
  justify-content: center;
  flex-wrap: wrap;
}

.processing-indicator {
  text-align: center;
  padding: 2rem;
  background: rgba(2, 132, 199, 0.1);
  border-radius: 0.75rem;
  border: 1px solid var(--primary);
  margin-top: 1rem;
}

.processing-spinner {
  width: 50px;
  height: 50px;
  margin: 0 auto 1rem;
  border: 4px solid var(--dark-border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.verification-result {
  background: var(--dark-bg);
  border: 1px solid var(--dark-border);
  border-radius: 0.75rem;
  padding: 2rem;
  text-align: center;
}

.result-content.success {
  background: rgba(34, 197, 94, 0.1);
  border: 1px solid var(--success);
  padding: 1.5rem;
  border-radius: 0.5rem;
}

.result-content.success h3 {
  color: var(--success);
  margin-top: 0;
}

.result-content.error {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid var(--error);
  padding: 1.5rem;
  border-radius: 0.5rem;
}

.result-content.error h3 {
  color: var(--error);
  margin-top: 0;
}

.result-confidence {
  margin: 1rem 0;
  padding: 1rem;
  background: var(--dark-surface);
  border-radius: 0.5rem;
  font-size: 0.95rem;
}

.verify-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-top: 2rem;
}

.info-card {
  background: var(--dark-bg);
  padding: 1.5rem;
  border-radius: 0.75rem;
  border: 1px solid var(--dark-border);
}

.info-card h3 {
  margin-top: 0;
  margin-bottom: 1rem;
  color: var(--primary-light);
}

.info-card ul {
  margin: 0;
  padding-left: 1.5rem;
  list-style: none;
}

.info-card li {
  margin-bottom: 0.5rem;
  padding-left: 1.5rem;
  position: relative;
  color: var(--dark-text);
}

.info-card li:before {
  content: "‚úì";
  position: absolute;
  left: 0;
  color: var(--success);
  font-weight: bold;
}

.info-card p {
  margin: 0.5rem 0;
  color: var(--dark-text);
}

.info-card.backup-code {
  border-left: 4px solid var(--warning);
}

.info-card.backup-code h3 {
  color: var(--warning);
}

.text-muted {
  color: var(--dark-text-muted);
  font-size: 0.9rem;
}
</style>

<script>
const startVerifyBtn = document.getElementById('startVerifyBtn');
const captureVerifyBtn = document.getElementById('captureVerifyBtn');
const stopVerifyBtn = document.getElementById('stopVerifyBtn');
const verifyCamera = document.getElementById('verifyCamera');
const verifyCanvas = document.getElementById('verifyCanvas');
const verificationStatus = document.getElementById('verificationStatus');
const processingIndicator = document.getElementById('processingIndicator');
const verificationResult = document.getElementById('verificationResult');
const retryVerifyBtn = document.getElementById('retryVerifyBtn');
const confidenceMeter = document.getElementById('confidenceMeter');
const meterFill = document.getElementById('meterFill');
const confidenceText = document.getElementById('confidenceText');

let verifyStream = null;

// Start verification
startVerifyBtn.addEventListener('click', async () => {
  try {
    verifyStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user' }
    });
    verifyCamera.srcObject = verifyStream;
    startVerifyBtn.style.display = 'none';
    captureVerifyBtn.style.display = 'inline-block';
    stopVerifyBtn.style.display = 'inline-block';
    verificationStatus.textContent = '‚úÖ Camera ready';
    startConfidenceDetection();
  } catch (err) {
    verificationStatus.classList.add('error');
    verificationStatus.innerHTML = `<span class="status-dot"></span><span class="status-text">Camera access denied</span>`;
  }
});

// Stop camera
stopVerifyBtn.addEventListener('click', () => {
  if (verifyStream) {
    verifyStream.getTracks().forEach(track => track.stop());
  }
  startVerifyBtn.style.display = 'inline-block';
  captureVerifyBtn.style.display = 'none';
  stopVerifyBtn.style.display = 'none';
  confidenceMeter.style.display = 'none';
});

// Capture for verification
captureVerifyBtn.addEventListener('click', () => {
  const ctx = verifyCanvas.getContext('2d');
  verifyCanvas.width = verifyCamera.videoWidth;
  verifyCanvas.height = verifyCamera.videoHeight;
  ctx.drawImage(verifyCamera, 0, 0);

  verifyFace();
});

async function verifyFace() {
  processingIndicator.style.display = 'block';
  verificationStatus.classList.remove('success', 'error');
  
  try {
    const base64Data = verifyCanvas.toDataURL('image/jpeg').split(',')[1];
    const binaryString = atob(base64Data);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }

    const formData = new FormData();
    formData.append('face_image', new Blob([bytes], { type: 'image/jpeg' }), 'face.jpg');

    const response = await fetch('{{ url_for("admin_secure.verify_facial_id") }}', {
      method: 'POST',
      body: formData
    });

    const result = await response.json();
    processingIndicator.style.display = 'none';

    if (result.success) {
      showSuccessResult(result);
      verificationStatus.classList.add('success');
      verificationStatus.innerHTML = `<span class="status-dot"></span><span class="status-text">Verification successful!</span>`;
      
      // Redirect after brief delay
      setTimeout(() => {
        window.location.href = '{{ url_for("admin_secure.dashboard") }}';
      }, 2000);
    } else {
      showErrorResult(result);
      verificationStatus.classList.add('error');
      verificationStatus.innerHTML = `<span class="status-dot"></span><span class="status-text">Verification failed</span>`;
    }
  } catch (error) {
    processingIndicator.style.display = 'none';
    showErrorResult({ message: 'Error: ' + error.message });
  }
}

function showSuccessResult(data) {
  const resultContent = document.getElementById('resultContent');
  const confidence = (data.confidence * 100).toFixed(1);
  
  resultContent.className = 'result-content success';
  resultContent.innerHTML = `
    <h3>‚úÖ Identity Verified!</h3>
    <p>Your face has been successfully recognized.</p>
    <div class="result-confidence">
      <strong>Confidence:</strong> ${confidence}%<br>
      <strong>Matches:</strong> ${data.match_count}
    </div>
    <p class="text-muted">Redirecting to admin dashboard...</p>
  `;
  verificationResult.style.display = 'block';
  captureVerifyBtn.style.display = 'none';
  stopVerifyBtn.style.display = 'none';
}

function showErrorResult(data) {
  const resultContent = document.getElementById('resultContent');
  resultContent.className = 'result-content error';
  resultContent.innerHTML = `
    <h3>‚ùå Verification Failed</h3>
    <p>${data.message}</p>
  `;
  verificationResult.style.display = 'block';
}

retryVerifyBtn.addEventListener('click', () => {
  verificationResult.style.display = 'none';
  captureVerifyBtn.style.display = 'inline-block';
  stopVerifyBtn.style.display = 'inline-block';
});

function startConfidenceDetection() {
  confidenceMeter.style.display = 'block';
  
  setInterval(() => {
    if (!verifyStream) return;
    
    // Simulate confidence detection
    const confidence = Math.random() * 100;
    const percentage = Math.min(confidence, 100);
    
    meterFill.style.width = percentage + '%';
    confidenceText.textContent = `Confidence: ${percentage.toFixed(0)}%`;
    
    if (percentage > 80) {
      verificationStatus.classList.remove('error');
      verificationStatus.classList.add('success');
    } else if (percentage < 40) {
      verificationStatus.classList.remove('success');
      verificationStatus.classList.add('error');
    } else {
      verificationStatus.classList.remove('success', 'error');
    }
  }, 300);
}
</script>
{% endblock %}
