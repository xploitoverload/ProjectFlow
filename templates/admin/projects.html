<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Projects - ProjectFlow</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/design-system.css') }}">
    <script src="{{ url_for('static', filename='js/lucide.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-features.css') }}">
    <script src="{{ url_for('static', filename='js/theme-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notification-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/inline-edit.js') }}"></script>
</head>

<body>
    <div class="app-shell">
        <!-- Sidebar -->
        <aside class="app-sidebar">
            <div class="sidebar-header">
                <a href="{{ url_for('main.dashboard') }}" class="sidebar-logo">
                    <div class="sidebar-logo-icon">
                        <i data-lucide="layers" style="width: 20px; height: 20px;"></i>
                    </div>
                    <span class="sidebar-logo-text">ProjectFlow</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Main</div>
                    <a href="{{ url_for('main.dashboard') }}" class="sidebar-nav-item">
                        <i data-lucide="layout-dashboard" class="nav-icon"></i>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Administration</div>
                    <a href="{{ url_for('admin.admin_dashboard') }}" class="sidebar-nav-item">
                        <i data-lucide="gauge" class="nav-icon"></i>
                        <span>Overview</span>
                    </a>
                    <a href="{{ url_for('admin.admin_projects') }}" class="sidebar-nav-item active">
                        <i data-lucide="folder" class="nav-icon"></i>
                        <span>Projects</span>
                    </a>
                    <a href="{{ url_for('admin.admin_users') }}" class="sidebar-nav-item">
                        <i data-lucide="users" class="nav-icon"></i>
                        <span>Users</span>
                    </a>
                    <a href="{{ url_for('admin.admin_teams') }}" class="sidebar-nav-item">
                        <i data-lucide="users-round" class="nav-icon"></i>
                        <span>Teams</span>
                    </a>
                    <a href="{{ url_for('admin.security_dashboard') }}" class="sidebar-nav-item">
                        <i data-lucide="shield" class="nav-icon"></i>
                        <span>Security</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <a href="{{ url_for('main.profile') }}" class="sidebar-user">
                    <div class="sidebar-user-avatar">{{ current_user.username[:2].upper() if
                        current_user.is_authenticated else 'U' }}</div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name">{{ current_user.username if current_user.is_authenticated else
                            'User' }}</div>
                        <div class="sidebar-user-role">Administrator</div>
                    </div>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="app-main">
            <header class="app-header">
                <div class="header-left">
                    <div class="header-breadcrumb">
                        <span>Admin</span>
                        <i data-lucide="chevron-right" class="header-breadcrumb-separator"
                            style="width: 14px; height: 14px;"></i>
                        <span class="header-breadcrumb-current">Projects</span>
                    </div>
                </div>
                <div class="header-right">
                    <!-- Theme Toggle -->
                    <button class="header-icon-btn theme-toggle-btn" id="themeToggle" title="Toggle Theme">
                        <i data-lucide="moon"></i>
                    </button>

                    <!-- Notifications -->
                    <button class="header-icon-btn" id="notificationBtn" title="Notifications"
                        style="position: relative;">
                        <i data-lucide="bell"></i>
                        <span class="notification-badge">0</span>
                    </button>

                    <a href="{{ url_for('auth.logout') }}" class="btn btn-ghost btn-sm">
                        <i data-lucide="log-out" class="icon-sm"></i>
                        Sign out
                    </a>
                </div>
            </header>

            <div class="app-content">
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ 'error' if category == 'danger' else category }}">
                    <i data-lucide="{{ 'alert-circle' if category in ['danger', 'error'] else 'check-circle' }}"
                        class="alert-icon"></i>
                    <div class="alert-content">{{ message }}</div>
                </div>
                {% endfor %}
                {% endif %}
                {% endwith %}

                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-header-top">
                        <div>
                            <h1 class="page-title">Project Management</h1>
                            <p class="page-subtitle">Manage all projects across the organization</p>
                        </div>
                        <div class="page-header-actions">
                            <button class="btn btn-primary" onclick="openAddProjectModal()">
                                <i data-lucide="plus" class="icon-sm"></i>
                                New Project
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-4 mb-6">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon primary">
                                <i data-lucide="folder" class="icon-lg"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">{{ projects|length if projects is defined else 0 }}</div>
                        <div class="stat-card-label">Total Projects</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon success">
                                <i data-lucide="check-circle" class="icon-lg"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">{{ projects|selectattr('status', 'equalto',
                            'completed')|list|length if projects is defined else 0 }}</div>
                        <div class="stat-card-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon warning">
                                <i data-lucide="play-circle" class="icon-lg"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">{{ projects|selectattr('status', 'equalto',
                            'in_progress')|list|length if projects is defined else 0 }}</div>
                        <div class="stat-card-label">In Progress</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon info">
                                <i data-lucide="square" class="icon-lg"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">{{ total_issues if total_issues is defined else 0 }}</div>
                        <div class="stat-card-label">Total Issues</div>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div class="tabs mb-6">
                    <button class="tab active" data-filter="all">All Projects</button>
                    <button class="tab" data-filter="active">Active</button>
                    <button class="tab" data-filter="completed">Completed</button>
                    <button class="tab" data-filter="on_hold">On Hold</button>
                </div>

                <!-- Projects Table -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">All Projects</h2>
                        <div class="header-search" style="width: 220px;">
                            <i data-lucide="search" class="header-search-icon"></i>
                            <input type="text" id="projectSearch" class="header-search-input"
                                placeholder="Search projects...">
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        {% if projects %}
                        <div class="table-container" style="border: none; border-radius: 0;">
                            <table class="table" id="projectsTable">
                                <thead>
                                    <tr>
                                        <th>Project</th>
                                        <th>Lead</th>
                                        <th>Team</th>
                                        <th>Status</th>
                                        <th>Progress</th>
                                        <th>Created</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for project in projects %}
                                    <tr data-status="{{ project.status or 'active' }}">
                                        <td>
                                            <div class="flex items-center gap-3">
                                                <div class="avatar avatar-sm project-color-avatar" style="--avatar-bg: {{ project.color }};"></div>
                                                    <i data-lucide="folder" class="icon-sm"></i>
                                                </div>
                                                <div>
                                                    <a href="{{ url_for('projects.project_detail', project_id=project.id) }}"
                                                        class="font-medium text-primary hover:underline">{{ project.name
                                                        }}</a>
                                                    <p class="text-xs text-tertiary">{{ project.key if project.key else
                                                        project.name[:3].upper() }}</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if project.lead %}
                                            <div class="flex items-center gap-2">
                                                <div class="avatar avatar-xs">{{ project.lead.username[:2].upper() }}
                                                </div>
                                                <span class="text-sm">{{ project.lead.username }}</span>
                                            </div>
                                            {% else %}
                                            <span class="text-tertiary">Unassigned</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-secondary">{{ project.team.name if project.team else 'N/A' }}
                                        </td>
                                        <td>
                                            {% set status = project.status or 'active' %}
                                            <span
                                                class="badge badge-{{ 'success' if status == 'completed' else 'warning' if status == 'in_progress' else 'info' if status == 'active' else 'gray' }}">
                                                {{ status.replace('_', ' ').title() }}
                                            </span>
                                        </td>
                                        <td>
                                            {% set progress = project.progress if project.progress is defined else 0 %}
                                            <div class="flex items-center gap-2" style="min-width: 120px;">
                                                <div class="progress-bar" style="flex: 1; height: 6px;">
                                                    <div class="progress-bar-fill" style="--progress: {{ progress }}%;"></div>
                                                </div>
                                                <span class="text-xs text-secondary">{{ progress }}%</span>
                                            </div>
                                        </td>
                                        <td class="text-tertiary text-sm">
                                            {{ project.created_at.strftime('%b %d, %Y') if project.created_at else 'N/A'
                                            }}
                                        </td>
                                        <td>
                                            <div class="flex items-center gap-1">
                                                <a href="{{ url_for('projects.project_detail', project_id=project.id) }}"
                                                    class="btn btn-ghost btn-sm btn-icon" title="View">
                                                    <i data-lucide="eye" class="icon-sm"></i>
                                                </a>
                                                <a href="{{ url_for('projects.project_kanban', project_id=project.id) }}"
                                                    class="btn btn-ghost btn-sm btn-icon" title="Kanban">
                                                    <i data-lucide="kanban" class="icon-sm"></i>
                                                </a>
                                                <button class="btn btn-ghost btn-sm btn-icon edit-project-btn"
                                                    title="Edit" data-project-id="{{ project.id }}"
                                                    data-project-name="{{ project.name }}"
                                                    data-project-key="{{ project.key }}"
                                                    data-project-description="{{ project.description }}"
                                                    data-project-status="{{ project.status }}"
                                                    data-project-workflow="{{ project.workflow_type }}"
                                                    data-project-team-ids="{{ project.teams.all()|map(attribute='id')|join(',') }}"
                                                    data-project-lead-id="{{ project.lead_id or '' }}"
                                                    data-project-start="{{ project.start_date or '' }}"
                                                    data-project-end="{{ project.end_date or '' }}">
                                                    <i data-lucide="pencil" class="icon-sm"></i>
                                                </button>
                                                <form method="POST"
                                                    action="{{ url_for('admin.delete_project', project_id=project.id) }}"
                                                    style="margin: 0;"
                                                    onsubmit="return confirm('Delete this project? This cannot be undone.');">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="btn btn-ghost btn-sm btn-icon"
                                                        title="Delete">
                                                        <i data-lucide="trash-2" class="icon-sm"
                                                            style="color: var(--error-500);"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i data-lucide="folder" class="empty-state-icon"></i>
                            <h3 class="empty-state-title">No projects found</h3>
                            <p class="empty-state-text">Create your first project to get started</p>
                            <button class="btn btn-primary" onclick="openAddProjectModal()">
                                <i data-lucide="plus" class="icon-sm"></i>
                                New Project
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Project Modal -->
    <div class="modal-backdrop" id="addProjectModal"
        style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 10000; padding: 20px;">
        <div class="modal"
            style="max-width: 560px; width: 100%; max-height: 80vh; background: white; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden;">
            <div class="modal-header" style="padding: 20px 24px; border-bottom: 1px solid #e5e7eb; flex-shrink: 0;">
                <h3 class="modal-title" style="margin: 0; font-size: 18px; font-weight: 600;">Create New Project</h3>
                <button class="modal-close" onclick="closeAddProjectModal()"
                    style="background: none; border: none; cursor: pointer; padding: 4px;">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form method="POST" action="{{ url_for('admin.add_project') }}"
                style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body" style="padding: 24px; overflow-y: auto; flex: 1;">
                    <div class="form-group">
                        <label class="form-label">Project Name</label>
                        <input type="text" name="name" class="form-input" placeholder="Enter project name" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Project Key</label>
                            <input type="text" name="key" class="form-input" placeholder="e.g. PROJ" maxlength="10"
                                style="text-transform: uppercase;">
                            <p class="form-hint">Unique identifier for issues</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                                <option value="Not Started">Not Started</option>
                                <option value="Active">Active</option>
                                <option value="In Progress">In Progress</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Completed">Completed</option>
                                <option value="At Risk">At Risk</option>
                                <option value="Blocked">Blocked</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Workflow Type</label>
                            <select name="workflow_type" class="form-select">
                                <option value="agile">Agile</option>
                                <option value="kanban">Kanban</option>
                                <option value="scrum">Scrum</option>
                                <option value="waterfall">Waterfall</option>
                                <option value="hybrid">Hybrid</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-textarea" rows="2"
                            placeholder="Brief description of the project"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Lead</label>
                        <select name="lead_id" class="form-select" id="addProjectLeadSelect">
                            <option value="">Select Lead</option>
                            <optgroup label="ðŸ‘‘ Team Leads & Managers">
                                {% for user in users if 'lead' in user.role or 'manager' in user.role or 'director' in
                                user.role %}
                                <option value="{{ user.id }}">{{ user.username }} ({{ user.role|format_role }})</option>
                                {% endfor %}
                            </optgroup>
                            <optgroup label="ðŸ—ï¸ Architects & Principals">
                                {% for user in users if 'architect' in user.role or 'principal' in user.role %}
                                <option value="{{ user.id }}">{{ user.username }} ({{ user.role|format_role }})</option>
                                {% endfor %}
                            </optgroup>
                            <optgroup label="ðŸ‘¨â€ðŸ’» Senior Engineers">
                                {% for user in users if 'senior' in user.role and 'lead' not in user.role and 'manager'
                                not in user.role %}
                                <option value="{{ user.id }}">{{ user.username }} ({{ user.role|format_role }})</option>
                                {% endfor %}
                            </optgroup>
                            <optgroup label="ðŸ‘¤ All Other Users">
                                {% for user in users if 'lead' not in user.role and 'manager' not in user.role and
                                'director' not in user.role and 'architect' not in user.role and 'principal' not in
                                user.role and 'senior' not in user.role %}
                                <option value="{{ user.id }}">{{ user.username }} ({{ user.role|format_role }})</option>
                                {% endfor %}
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assign Teams</label>
                        <select name="team_ids" class="form-select" multiple size="4"
                            style="height: auto; min-height: 100px;">
                            {% for team in teams %}
                            <option value="{{ team.id }}">{{ team.name }} {% if team.team_type %}({{
                                team.team_type|title }}){% endif %}</option>
                            {% endfor %}
                        </select>
                        <p class="form-hint">Hold Ctrl/Cmd to select multiple teams. One project can have multiple teams
                            working on it.</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" name="start_date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" name="end_date" class="form-input">
                        </div>
                    </div>
                </div>
                <div class="modal-footer"
                    style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px; flex-shrink: 0; background: white;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddProjectModal()"
                        style="padding: 8px 16px; border-radius: 6px; cursor: pointer;">Cancel</button>
                    <button type="submit" class="btn btn-primary"
                        style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        <i data-lucide="plus" class="icon-sm"></i>
                        Create Project
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div class="modal-backdrop" id="editProjectModal"
        style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 10000; padding: 20px;">
        <div class="modal"
            style="max-width: 560px; width: 100%; max-height: 80vh; background: white; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden;">
            <div class="modal-header" style="padding: 20px 24px; border-bottom: 1px solid #e5e7eb; flex-shrink: 0;">
                <h3 class="modal-title" style="margin: 0; font-size: 18px; font-weight: 600;">Edit Project</h3>
                <button class="modal-close" onclick="closeEditProjectModal()"
                    style="background: none; border: none; cursor: pointer; padding: 4px;">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form method="POST" id="editProjectForm"
                style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body" style="padding: 24px; overflow-y: auto; flex: 1;">
                    <div class="form-group">
                        <label class="form-label">Project Name</label>
                        <input type="text" name="name" id="editProjectName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Key</label>
                        <input type="text" name="key" id="editProjectKey" class="form-input" placeholder="e.g., PROJ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea name="description" id="editProjectDescription" class="form-textarea"
                            rows="3"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select name="status" id="editProjectStatus" class="form-select">
                                <option value="Not Started">Not Started</option>
                                <option value="Active">Active</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Workflow Type</label>
                            <select name="workflow_type" id="editProjectWorkflow" class="form-select">
                                <option value="agile">Agile</option>
                                <option value="kanban">Kanban</option>
                                <option value="waterfall">Waterfall</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assign Teams</label>
                        <select name="team_ids" id="editProjectTeamIds" class="form-select" multiple size="4"
                            style="height: auto; min-height: 100px;">
                            {% for team in teams %}
                            <option value="{{ team.id }}">{{ team.name }} {% if team.team_type %}({{
                                team.team_type|title }}){% endif %}</option>
                            {% endfor %}
                        </select>
                        <p class="form-hint">Hold Ctrl/Cmd to select multiple teams.</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Lead</label>
                        <select name="lead_id" id="editProjectLeadId" class="form-select">
                            <option value="">Select Lead</option>
                            <optgroup label="ðŸ‘‘ Team Leads & Managers">
                                {% for user in users if 'lead' in user.role or 'manager' in user.role or 'director' in
                                user.role %}
                                <option value="{{ user.id }}">{{ user.username }} ({{ user.role|format_role }})</option>
                                {% endfor %}
                            </optgroup>
                            <optgroup label="ðŸ—ï¸ Architects & Principals">
                                {% for user in users if 'architect' in user.role or 'principal' in user.role %}
                                <option value="{{ user.id }}">{{ user.username }} ({{ user.role|format_role }})</option>
                                {% endfor %}
                            </optgroup>
                            <optgroup label="ðŸ‘¨â€ðŸ’» Senior Engineers">
                                {% for user in users if 'senior' in user.role and 'lead' not in user.role and 'manager'
                                not in user.role %}
                                <option value="{{ user.id }}">{{ user.username }} ({{ user.role|format_role }})</option>
                                {% endfor %}
                            </optgroup>
                            <optgroup label="ðŸ‘¤ All Other Users">
                                {% for user in users if 'lead' not in user.role and 'manager' not in user.role and
                                'director' not in user.role and 'architect' not in user.role and 'principal' not in
                                user.role and 'senior' not in user.role %}
                                <option value="{{ user.id }}">{{ user.username }} ({{ user.role|format_role }})</option>
                                {% endfor %}
                            </optgroup>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" name="start_date" id="editProjectStart" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" name="end_date" id="editProjectEnd" class="form-input">
                        </div>
                    </div>
                </div>
                <div class="modal-footer"
                    style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px; flex-shrink: 0; background: white;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditProjectModal()"
                        style="padding: 8px 16px; border-radius: 6px; cursor: pointer;">Cancel</button>
                    <button type="submit" class="btn btn-primary"
                        style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        <i data-lucide="save" class="icon-sm"></i>
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        lucide.createIcons();

        function openAddProjectModal() {
            document.getElementById('addProjectModal').style.display = 'flex';
        }

        function closeAddProjectModal() {
            document.getElementById('addProjectModal').style.display = 'none';
        }

        function openEditProjectModal(projectId, name, key, description, status, workflow, teamIds, leadId, startDate, endDate) {
            const modal = document.getElementById('editProjectModal');
            const form = document.getElementById('editProjectForm');

            form.action = `/admin/project/${projectId}/edit`;
            document.getElementById('editProjectName').value = name || '';
            document.getElementById('editProjectKey').value = key || '';
            document.getElementById('editProjectDescription').value = description || '';
            document.getElementById('editProjectStatus').value = status || 'Not Started';
            document.getElementById('editProjectWorkflow').value = workflow || 'agile';
            document.getElementById('editProjectLeadId').value = leadId || '';
            document.getElementById('editProjectStart').value = startDate || '';
            document.getElementById('editProjectEnd').value = endDate || '';

            // Handle multi-select for teams
            const teamSelect = document.getElementById('editProjectTeamIds');
            // Clear previous selections
            Array.from(teamSelect.options).forEach(opt => opt.selected = false);
            // Select current teams
            if (teamIds) {
                const ids = teamIds.split(',').map(id => id.trim());
                ids.forEach(id => {
                    const opt = teamSelect.querySelector(`option[value="${id}"]`);
                    if (opt) opt.selected = true;
                });
            }

            modal.style.display = 'flex';
            lucide.createIcons();
        }

        function closeEditProjectModal() {
            document.getElementById('editProjectModal').style.display = 'none';
        }

        // Event listeners for edit buttons
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.edit-project-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    openEditProjectModal(
                        this.dataset.projectId,
                        this.dataset.projectName,
                        this.dataset.projectKey,
                        this.dataset.projectDescription,
                        this.dataset.projectStatus,
                        this.dataset.projectWorkflow,
                        this.dataset.projectTeamIds,
                        this.dataset.projectLeadId,
                        this.dataset.projectStart,
                        this.dataset.projectEnd
                    );
                });
            });
        });

        // Search
        document.getElementById('projectSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('#projectsTable tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        });

        // Filter tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const filter = tab.dataset.filter;
                document.querySelectorAll('#projectsTable tbody tr').forEach(row => {
                    if (filter === 'all') {
                        row.style.display = '';
                    } else {
                        row.style.display = row.dataset.status === filter ? '' : 'none';
                    }
                });
            });
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeAddProjectModal();
                closeEditProjectModal();
            }
        });

        document.getElementById('addProjectModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeAddProjectModal();
        });

        document.getElementById('editProjectModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeEditProjectModal();
        });
    </script>

    <script>
        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Initialize theme toggle
        document.getElementById('themeToggle')?.addEventListener('click', () => {
            window.themeManager.toggleTheme();
        });

        // Initialize notification button
        document.getElementById('notificationBtn')?.addEventListener('click', () => {
            window.notificationManager?.togglePanel();
        });
    </script>
</body>

</html>