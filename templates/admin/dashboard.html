{% extends "admin/base.html" %}

{% block title %}Admin Dashboard{% endblock %}
{% block breadcrumb %}Dashboard{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="page-header-top">
        <div>
            <h1 class="page-title">Admin Dashboard</h1>
            <p class="page-subtitle">System overview and management</p>
        </div>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px;">
    <div class="admin-card">
        <div class="admin-card-body" style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 48px; height: 48px; background: rgba(88, 166, 255, 0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="folder" style="width: 24px; height: 24px; color: var(--admin-accent);"></i>
            </div>
            <div>
                <div style="font-size: 28px; font-weight: 700; color: var(--admin-text);">{{ projects|length if projects is defined else project_count|default(0) }}</div>
                <div style="font-size: 14px; color: var(--admin-text-secondary);">Total Projects</div>
            </div>
        </div>
    </div>

    <div class="admin-card">
        <div class="admin-card-body" style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 48px; height: 48px; background: rgba(136, 87, 229, 0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="users" style="width: 24px; height: 24px; color: #8957E5;"></i>
            </div>
            <div>
                <div style="font-size: 28px; font-weight: 700; color: var(--admin-text);">{{ users|length if users is defined else user_count|default(0) }}</div>
                <div style="font-size: 14px; color: var(--admin-text-secondary);">Total Users</div>
            </div>
        </div>
    </div>

    <div class="admin-card">
        <div class="admin-card-body" style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 48px; height: 48px; background: rgba(35, 134, 54, 0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="activity" style="width: 24px; height: 24px; color: #238636;"></i>
            </div>
            <div>
                <div style="font-size: 28px; font-weight: 700; color: #238636;">{{ online_users_count|default(0) }}</div>
                <div style="font-size: 14px; color: var(--admin-text-secondary);">Online Now</div>
            </div>
        </div>
    </div>

    <div class="admin-card">
        <div class="admin-card-body" style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 48px; height: 48px; background: rgba(35, 134, 54, 0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="users-round" style="width: 24px; height: 24px; color: #238636;"></i>
            </div>
            <div>
                <div style="font-size: 28px; font-weight: 700; color: var(--admin-text);">{{ teams|length if teams is defined else team_count|default(0) }}</div>
                <div style="font-size: 14px; color: var(--admin-text-secondary);">Teams</div>
            </div>
        </div>
    </div>

    <div class="admin-card">
        <div class="admin-card-body" style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 48px; height: 48px; background: rgba(210, 153, 34, 0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="list-todo" style="width: 24px; height: 24px; color: #D29922;"></i>
            </div>
            <div>
                <div style="font-size: 28px; font-weight: 700; color: var(--admin-text);">{{ total_issues if total_issues is defined else issue_count|default(0) }}</div>
                <div style="font-size: 14px; color: var(--admin-text-secondary);">Total Issues</div>
            </div>
        </div>
    </div>

    <div class="admin-card">
        <div class="admin-card-body" style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 48px; height: 48px; background: rgba(124, 77, 255, 0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="camera" style="width: 24px; height: 24px; color: #7C4DFF;"></i>
            </div>
            <div>
                <div style="font-size: 28px; font-weight: 700; color: var(--admin-text);" id="facialIdCount">0</div>
                <div style="font-size: 14px; color: var(--admin-text-secondary);">Facial ID Enrolled</div>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Section -->
<div class="admin-grid grid-3" style="margin-bottom: 32px;">
    <div class="admin-card">
        <div class="admin-card-header">
            <h2 class="admin-card-title">Project Status</h2>
        </div>
        <div class="admin-card-body">
            <div style="display: flex; flex-direction: column; gap: 12px;">
                {% if project_status %}
                    {% for status, count in project_status.items() %}
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--admin-bg-tertiary); border-radius: 8px;">
                        <span style="font-size: 14px;">{{ status }}</span>
                        <span style="background: {{ 'rgba(35, 134, 54, 0.15)' if status == 'Completed' else 'rgba(210, 153, 34, 0.15)' if status == 'In Progress' else 'rgba(88, 166, 255, 0.15)' }}; color: {{ '#7EE787' if status == 'Completed' else '#D29922' if status == 'In Progress' else 'var(--admin-accent)' }}; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                            {{ count }}
                        </span>
                    </div>
                    {% endfor %}
                {% else %}
                <p class="text-secondary" style="font-size: 14px;">No project data available</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="admin-card">
        <div class="admin-card-header">
            <h2 class="admin-card-title">Users Online</h2>
        </div>
        <div class="admin-card-body">
            <div style="display: flex; flex-direction: column; gap: 12px;">
                {% if online_users %}
                    {% for user in online_users[:4] %}
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: var(--admin-bg-tertiary); border-radius: 8px;">
                        <div style="position: relative; width: 36px; height: 36px;">
                            <div style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--admin-accent), #8957E5); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; color: white;">
                                {{ user.username[:2].upper() }}
                            </div>
                            <div style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: #238636; border: 2px solid var(--admin-bg-tertiary); border-radius: 50%;"></div>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 14px; font-weight: 500;">{{ user.username }}</div>
                            <div style="font-size: 12px; color: var(--admin-text-secondary);">{{ user.role|title }}</div>
                        </div>
                        <span style="background: rgba(35, 134, 54, 0.15); color: #7EE787; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 500;">Online</span>
                    </div>
                    {% endfor %}
                    {% if online_users|length > 4 %}
                    <div style="text-align: center; padding: 8px;">
                        <span style="font-size: 12px; color: var(--admin-text-secondary);">+{{ online_users|length - 4 }} more online</span>
                    </div>
                    {% endif %}
                {% elif recent_users %}
                    {% for user in recent_users[:4] %}
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: var(--admin-bg-tertiary); border-radius: 8px;">
                        <div style="position: relative; width: 36px; height: 36px;">
                            <div style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--admin-accent), #8957E5); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; color: white;">
                                {{ user.username[:2].upper() }}
                            </div>
                            {% if user.is_online %}
                            <div style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: #238636; border: 2px solid var(--admin-bg-tertiary); border-radius: 50%;"></div>
                            {% else %}
                            <div style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: #6e7681; border: 2px solid var(--admin-bg-tertiary); border-radius: 50%;"></div>
                            {% endif %}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 14px; font-weight: 500;">{{ user.username }}</div>
                            <div style="font-size: 12px; color: var(--admin-text-secondary);">{{ user.role|title }}</div>
                        </div>
                        {% if user.is_online %}
                        <span style="background: rgba(35, 134, 54, 0.15); color: #7EE787; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 500;">Online</span>
                        {% else %}
                        <span style="background: rgba(110, 118, 129, 0.15); color: #8b949e; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 500;">Offline</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                <p class="text-secondary" style="font-size: 14px; text-align: center;">No users online</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="admin-card">
        <div class="admin-card-header">
            <h2 class="admin-card-title">Security Overview</h2>
        </div>
        <div class="admin-card-body">
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--admin-bg-tertiary); border-radius: 8px;">
                    <span style="font-size: 14px;">Security Events (24h)</span>
                    <span style="background: {{ 'rgba(35, 134, 54, 0.15)' if (security_events|length if security_events else 0) < 5 else 'rgba(210, 153, 34, 0.15)' }}; color: {{ '#7EE787' if (security_events|length if security_events else 0) < 5 else '#D29922' }}; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                        {{ security_events|length if security_events else 0 }}
                    </span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--admin-bg-tertiary); border-radius: 8px;">
                    <span style="font-size: 14px;">Suspicious Activity</span>
                    <span style="background: {{ 'rgba(35, 134, 54, 0.15)' if (suspicious|length if suspicious else 0) == 0 else 'rgba(248, 81, 73, 0.15)' }}; color: {{ '#7EE787' if (suspicious|length if suspicious else 0) == 0 else '#F85149' }}; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                        {{ suspicious|length if suspicious else 0 }}
                    </span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--admin-bg-tertiary); border-radius: 8px;">
                    <span style="font-size: 14px;">System Health</span>
                    <span style="background: rgba(35, 134, 54, 0.15); color: #7EE787; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                        Healthy
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="admin-grid grid-4" style="margin-bottom: 32px;">
    <a href="{{ url_for('admin.admin_tools') }}" class="admin-card" style="text-decoration: none; transition: all 0.2s ease; border: 2px solid var(--admin-accent);">
        <div class="admin-card-body" style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 48px; height: 48px; background: rgba(88, 166, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="wrench" style="width: 24px; height: 24px; color: var(--admin-accent);"></i>
            </div>
            <div>
                <h3 style="margin: 0 0 4px; font-size: 16px; font-weight: 600; color: var(--admin-text);">Admin Tools</h3>
                <p style="margin: 0; font-size: 13px; color: var(--admin-text-secondary);">All tools in one place</p>
            </div>
        </div>
    </a>

    <a href="{{ url_for('admin.admin_projects') }}" class="admin-card" style="text-decoration: none; transition: all 0.2s ease;">
        <div class="admin-card-body" style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 48px; height: 48px; background: rgba(88, 166, 255, 0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="folder-plus" style="width: 24px; height: 24px; color: var(--admin-accent);"></i>
            </div>
            <div>
                <h3 style="margin: 0 0 4px; font-size: 16px; font-weight: 600; color: var(--admin-text);">Manage Projects</h3>
                <p style="margin: 0; font-size: 13px; color: var(--admin-text-secondary);">Create, edit, and delete projects</p>
            </div>
        </div>
    </a>

    <a href="{{ url_for('admin.admin_users') }}" class="admin-card" style="text-decoration: none; transition: all 0.2s ease;">
        <div class="admin-card-body" style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 48px; height: 48px; background: rgba(136, 87, 229, 0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="user-plus" style="width: 24px; height: 24px; color: #8957E5;"></i>
            </div>
            <div>
                <h3 style="margin: 0 0 4px; font-size: 16px; font-weight: 600; color: var(--admin-text);">Manage Users</h3>
                <p style="margin: 0; font-size: 13px; color: var(--admin-text-secondary);">Add and manage user accounts</p>
            </div>
        </div>
    </a>

    <a href="{{ url_for('admin.admin_teams') }}" class="admin-card" style="text-decoration: none; transition: all 0.2s ease;">
        <div class="admin-card-body" style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 48px; height: 48px; background: rgba(35, 134, 54, 0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="users-round" style="width: 24px; height: 24px; color: #238636;"></i>
            </div>
            <div>
                <h3 style="margin: 0 0 4px; font-size: 16px; font-weight: 600; color: var(--admin-text);">Manage Teams</h3>
                <p style="margin: 0; font-size: 13px; color: var(--admin-text-secondary);">Create and organize teams</p>
            </div>
        </div>
    </a>
</div>

<!-- Recent Projects & System Info -->
<div class="admin-grid" style="grid-template-columns: 2fr 1fr; gap: 24px;">
    <!-- Recent Projects -->
    <div class="admin-card">
        <div class="admin-card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="admin-card-title">Recent Projects</h2>
            <a href="{{ url_for('admin.admin_projects') }}" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">View all</a>
        </div>
        <div class="admin-card-body" style="padding: 0;">
            {% if projects %}
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--admin-border);">
                            <th style="padding: 14px 20px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--admin-text-secondary);">Project</th>
                            <th style="padding: 14px 20px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--admin-text-secondary);">Status</th>
                            <th style="padding: 14px 20px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--admin-text-secondary);">Team</th>
                            <th style="padding: 14px 20px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--admin-text-secondary);">Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in projects[:5] %}
                        <tr style="border-bottom: 1px solid var(--admin-border);">
                            <td style="padding: 14px 20px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--admin-accent), #8957E5); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; color: white;">
                                        {{ project.name[:2].upper() }}
                                    </div>
                                    <span style="font-weight: 500;">{{ project.name }}</span>
                                </div>
                            </td>
                            <td style="padding: 14px 20px;">
                                <span style="background: {{ 'rgba(35, 134, 54, 0.15)' if project.status == 'Completed' else 'rgba(210, 153, 34, 0.15)' if project.status == 'In Progress' else 'rgba(88, 166, 255, 0.15)' }}; color: {{ '#7EE787' if project.status == 'Completed' else '#D29922' if project.status == 'In Progress' else 'var(--admin-accent)' }}; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">
                                    {{ project.status }}
                                </span>
                            </td>
                            <td style="padding: 14px 20px; color: var(--admin-text-secondary);">{{ project.team.name if project.team else 'Unassigned' }}</td>
                            <td style="padding: 14px 20px; color: var(--admin-text-secondary); font-size: 13px;">{{ project.created_at.strftime('%b %d') if project.created_at else 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align: center; padding: 60px 20px;">
                <div style="width: 64px; height: 64px; background: var(--admin-bg-tertiary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                    <i data-lucide="folder-open" style="width: 28px; height: 28px; color: var(--admin-text-secondary);"></i>
                </div>
                <p style="margin: 0; color: var(--admin-text-secondary);">No projects yet</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- System Info Sidebar -->
    <div style="display: flex; flex-direction: column; gap: 24px;">
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">System Status</h2>
            </div>
            <div class="admin-card-body">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 14px; color: var(--admin-text-secondary);">Database</span>
                        <span style="background: rgba(35, 134, 54, 0.15); color: #7EE787; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">Healthy</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 14px; color: var(--admin-text-secondary);">Security</span>
                        <span style="background: rgba(35, 134, 54, 0.15); color: #7EE787; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">Active</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 14px; color: var(--admin-text-secondary);">Encryption</span>
                        <span style="background: rgba(35, 134, 54, 0.15); color: #7EE787; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">Enabled</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">Quick Links</h2>
            </div>
            <div class="admin-card-body">
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <a href="{{ url_for('admin.admin_tools') }}" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: rgba(88, 166, 255, 0.1); border: 1px solid var(--admin-accent); border-radius: 8px; text-decoration: none; color: var(--admin-accent); transition: all 0.2s ease;">
                        <i data-lucide="wrench" style="width: 18px; height: 18px;"></i>
                        <span style="font-size: 14px; font-weight: 500;">All Admin Tools</span>
                    </a>
                    <a href="{{ url_for('admin.security_dashboard') }}" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--admin-bg-tertiary); border-radius: 8px; text-decoration: none; color: var(--admin-text); transition: all 0.2s ease;">
                        <i data-lucide="shield" style="width: 18px; height: 18px; color: var(--admin-text-secondary);"></i>
                        <span style="font-size: 14px;">Security Settings</span>
                    </a>
                    <a href="{{ url_for('admin_secure.facial_id_settings') }}" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--admin-bg-tertiary); border-radius: 8px; text-decoration: none; color: var(--admin-text); transition: all 0.2s ease;">
                        <i data-lucide="camera" style="width: 18px; height: 18px; color: var(--admin-text-secondary);"></i>
                        <span style="font-size: 14px;">Facial ID Settings</span>
                    </a>
                    <a href="{{ url_for('admin.audit_logs') }}" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--admin-bg-tertiary); border-radius: 8px; text-decoration: none; color: var(--admin-text); transition: all 0.2s ease;">
                        <i data-lucide="scroll-text" style="width: 18px; height: 18px; color: var(--admin-text-secondary);"></i>
                        <span style="font-size: 14px;">Audit Logs</span>
                    </a>
                    <a href="{{ url_for('admin.db_management') }}" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--admin-bg-tertiary); border-radius: 8px; text-decoration: none; color: var(--admin-text); transition: all 0.2s ease;">
                        <i data-lucide="database" style="width: 18px; height: 18px; color: var(--admin-text-secondary);"></i>
                        <span style="font-size: 14px;">Database</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load facial ID statistics
document.addEventListener('DOMContentLoaded', function() {
    loadFacialIDStats();
});

async function loadFacialIDStats() {
    try {
        // Get admin token from page or localStorage
        const adminToken = document.querySelector('[data-admin-token]')?.getAttribute('data-admin-token') || 
                          localStorage.getItem('admin_token') || '';
        
        if (!adminToken) return;

        const response = await fetch(`/secure-mgmt-${adminToken}/get-facial-stats`, {
            headers: {
                'X-Admin-Token': adminToken
            }
        });

        if (response.ok) {
            const data = await response.json();
            const count = data.enrolled_faces || 0;
            document.getElementById('facialIdCount').textContent = count;
        }
    } catch (e) {
        console.error('Error loading facial ID stats:', e);
    }
}
</script>
{% endblock %}
